#| Edward Flick
   Software Engineering I
   iEx4

   The iEx4 assignment to format bridge hands as HTML.
|#

(in-package "ACL2")

(include-book "io-utilities" :dir :teachpacks)
;(include-book "basiclex")
(include-book "xmlminidom")
(include-book "stringutils")

(set-state-ok t)

(defconst *div-open-1* "<div class=\"")
(defconst *div-open-2* "\">")
(defconst *div-close* "</div>")
(defconst *br* "<br />")
(defconst *htmlhead* 
  (stringlist-append 
   (list
    "<html><head><style>"
    "body {background-color: white; color: black;}"
    ".game {clear: both; position: relative; top: 0px; left: 0px;"
           "width: 45em; height: 30em; border: none;"
           "margin: 1em 1em; background-color: #f8f8f8;}\n"
    ".N {position: absolute; height: 10em; width: 15em; left: 15em;"
        "top: 0em; border: dashed 1px black; background-color: white;}\n"
    ".S {position: absolute; height: 10em; width: 15em; left: 15em;"
        "top: 20em; border: dashed 1px black; background-color: white;}\n"
    ".E {position: absolute; height: 10em; width: 15em; left: 30em;"
        "top: 10em; border: dashed 1px black; background-color: white;}\n"
    ".W {position: absolute; height: 10em; width: 15em; left: 0em;"
        "top: 10em; border: dashed 1px black; background-color: white;}\n"
    ".dealer {text-align: center; font-weight: bold; color: blue;}\n"
    ".vulnerable {text-align: center; font-weight: bold; color: red;}\n"        
    "</style></head><body>")))
(defconst *htmltail* "</body></html>")

; suit? (xmlnode) → returns true if xmlnode is of the following form:
; (mv "Suit"
;     (list (mv "symbol" ("S"||"H"||"D"||"C")))
;     (list (mv 'text nil stringp)))
(defun suit? (xmlnode)
  (and
   (true-listp xmlnode)
   (equal (len xmlnode) 3)
   (mv-let
    (node attribs children)
    xmlnode
    (and
     (equal node "Suit")
     (true-listp attribs)
     (equal (len attribs) 1)
     (let
         ((a (car attribs)))
       (and
        (true-listp a)
        (equal (len a) 2)
        (mv-let
         (an av)
         a
         (and
          (equal an "symbol")
          (member-equal av (list "S" "H" "D" "C"))
          ))))
     (true-listp children)
     (equal (len children) 1)
     (let
         ((c (car children)))
       (and
        (true-listp c)
        (equal (len c) 3)
        (mv-let
         (nodetype dontcare contents)
         c
         (and
          (equal nodetype 'text)
          (null dontcare)
          (stringp contents)
          ))))))))

; suit-list? (xmlnodes) → returns true if suit? is true for each item in
; the list xmlnodes
(defun suit-list? (xmlnodes)
  (and
   (true-listp xmlnodes)
   (or
    (null xmlnodes)
    (and
     (suit? (car xmlnodes))
     (suit-list? (cdr xmlnodes))))))

; gethandcards (xmlnodes) → returns concatenated list of strings composed
; of the concatenation of suite symbol in HTML and card characters from
; xmlnodes where xmlnodes is a list of Suite xml nodes
(defun gethandcards (xmlnodes)
  (if (null xmlnodes)
      ""
      (let* (
             (suite 
              (car xmlnodes))
             (rest
              (cdr xmlnodes))
             (suitesymbol
              (xml-getattribute suite "symbol"))
             (suitehtml
              (if
               (string-equal suitesymbol "S")
               "&spades;"
               (if
                (string-equal suitesymbol "C")
                "&clubs;"
                (if
                 (string-equal suitesymbol "D")
                 "&diams;"
                 "&hearts;"))))
             (cards
              (xml-gettext suite))
             )
        (stringlist-append
         (list
          suitehtml
          cards
          *br*
          (gethandcards rest)
          ))
        )))

; gethands (xmlnodes vulnerable dealer) → returns concatenated list of divs
; with class set to hand direction from xmlnodes, where xmlnodes is a list
; of xmlnode, of type hand, adds “vulnerable” and “dealer” divs inside the
; divs as necessary, and adds the cards to each hand
(defun gethands (xmlnodes vulnerable dealer)
  (if (null xmlnodes)
      ""
      (let* (
             (hand
              (car xmlnodes))
             (rest
              (cdr xmlnodes))
             (direction
              (xml-getattribute hand "direction"))
             (suites
              (xml-getnodes hand "Suit"))
             (dealerhtml
              (if (string-equal dealer direction)
                  (stringlist-append
                   (list
                    *div-open-1*
                    "dealer"
                    *div-open-2*
                    "Dealer"
                    *div-close*
                    ))
                  ""
               ))
             (vulnerablehtml
              (if
               (or
                (string-equal vulnerable "Both")
                (and
                 (string-equal vulnerable "NS")
                 (or
                  (string-equal direction "N")
                  (string-equal direction "S")
                 ))
                (and
                 (string-equal vulnerable "EW")
                 (or
                  (string-equal direction "E")
                  (string-equal direction "W")
                 ))
                )
               (stringlist-append
                (list
                 *div-open-1*
                 "vulnerable"
                 *div-open-2*
                 "Vulnerable"
                 *div-close*
                 ))
               ""
               ))
             )
        (stringlist-append 
         (list 
          *div-open-1*
          direction
          *div-open-2*
          dealerhtml
          vulnerablehtml
          (gethandcards suites)
          *div-close*
          (gethands rest vulnerable dealer))))))

; getgames (xmlnodes) → returns appended “game” class div strings from the
; xmlnodes “game” nodes formatted to be rendered as required by description
(defun getgames (xmlnodes)
  (if (null xmlnodes)
      ""
      (let* (
             (game (car xmlnodes))
             (rest (cdr xmlnodes))
             (vulnerable
              (xml-gettext (xml-getnode game "Vulnerable")))
             (dealer
              (xml-gettext (xml-getnode game "Dealer")))
             (hands
              (xml-getnodes (xml-getnode game "Deal") "Hand"))
             )
        (stringlist-append 
         (list 
          *div-open-1*
          "game"
          *div-open-2* 
          (gethands hands vulnerable dealer)
          *div-close*
          (getgames rest))))))

; main (infile outfile state) → Converts infile from bridgenet xml to html
; output and saves in outfile; returns (mv 'ok state) or (mv 'error state)
(defun main (infile outfile state)
  (mv-let (contents status state)
          (file->string (string-append infile ".xml") state)
          (if (null status)
              (mv-let
               (status state)
               (string-list->file
                (string-append outfile ".htm")
                (list
                 *htmlhead*
                 (getgames (xml-getnodes (xml-readnode contents) "Game"))
                 *htmltail*
                 )
                state)
               (if (null status)
                   (mv 'ok state)
                   (mv 'error state)))
              (mv 'error state))))

;(main "HR090826E" "testout1" state)
;(main "HR100818E" "testout2" state)